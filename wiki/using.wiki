#summary использование.

= Введение =

Данная статья рассказывает что нужно сделать чтобы записать во флэш-память платы AT91EB40 новый загрузчик.
Необходимость смены стандартного загрузчика появилась у меня после того как я попытался запустить [http://www.uclinux.org uClinux] на плате AT91EB40. Выяснилось, что оригинальный загрузчик (SRAM Downloader) не может загрузить код, объёмом более 65535 байт. Пришлось заняться модификацией исходного кода загрузчика. Результат и, возможно, развитие этой работы представлены здесь.

= Как записывать флэш-память AT91EB40 =

Если я правильно понял, Atmel предлагает, используя Angel debug monitor, записать в ОЗУ код для программирования флэш-памяти (Flash downloader), а затем этот код запишет во флэш то что вам нужно. То есть выглядеть это должно было так:
  # С помощью gdb-клиента соединяемся через RS-232 с Angel debug monitor (gdb сервером на плате).
  # Загружаем в ОЗУ платы elf-файл с кодом Flash downloader-а, при этом во время загрузки необходимо ещё как-то загрузить и собственно тот код, который нужно записать во флэш.
  # Запускаем программу записи.
Поскольку п.2 мне выполнить не удалось, я оставил идею с Flash downloader-ом и решил попробовать redboot:
http://ecos.sourceware.org/redboot/

Этот загрузчик способен загружать код как в ОЗУ так и во флэш. Однако уже скомпилированный код redboot для AT91EB40 так же имеет ограничения по объёму загружаемого кода. Этот объём не превышает 512к. Именно такой объём ОЗУ имеется на плате. Однако AT91EB40 допускает апгрейд ОЗУ вплоть до 2Мб что и необходимо для работы uClinux. И чтобы использовать redboot с таким объёмом нужно редактировать его исходные тексты и заново компилировать. Таким образом, из двух зол было выбрано меньшее - редактировать загрузчик Atmel-а. К тому же версия redboot работающая как и boot_eb40 из флэш работает очень медленно. Образ uClinux загружается в ОЗУ около 6 часов! А версия, работающая из ОЗУ, совершенно естественно занимает место в ОЗУ, в отличии от boot_eb40.
В итоге, решено redboot использовать в качестве программатора флэш-памяти платы, чтобы с его помощью записать во флэш новый загрузчик boot_eb40. Для этого выполним следующую последовательность действий:

  # Забираем [http://ecos.sourceware.org/ecos/boards/redbootbins/at91eb40/redboot_RAM.elf отсюда] скомпилированный образ redboot
  # Переключатель SW1 на плате переводим в положение "LOWER MEM"
  # Соединяем разъём "SERIAL A" платы с портом RS-232 компьютера.
  # Включаем плату. Должен загореться жёлтый светодиод.
  # В консоле переходим в директорию куда загрузили redboot_RAM.elf
  # Набираем в консоле:
{{{
$ arm-elf-gdb redboot_RAM.elf
...выводится информация о gdb-клиенте
(gdb) tar rdi /dev/ttyS0
...выводится приветствие Angel-а
(gdb) set $cpsr=0xd3
(gdb) load
...в ОЗУ платы загружается код из redboot_RAM.elf
(gdb) cont
Continue
...redboot загружен и работает
}}}
  # Нажимаем Ctrl-Z и выходим из gdb.
 
Add your content here.  Format your content with:
  * Text in *bold* or _italic_
  * Headings, paragraphs, and lists
  * Automatic links to other wiki pages